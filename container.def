Bootstrap: shub
From: singularityhub/centos:latest


# we could bootstrap from library too, but in comparison with shub it's too slow:
#BootStrap: library
#From: library://library/default/centos

%post
    # update centos, setup epel and install tools we need to install tools:
    yum -y install yum-utils epel-release yum-plugin-versionlock curl

    # Install OFED
    # - as we're going to install our custom-built OFED, we need to ensure that possibly higher-versioned packages
    #   from OS will not interfere with our libs. yum versionlock is one of the ways..

    version_list="compat-rdma-4.8-1.1.gd5db855.3.10.0_514.26.2.el7.x86_64.x86_64 compat-rdma-devel-4.8-1.1.gd5db855.3.10.0_514.26.2.el7.x86_64.x86_64 dapl-2.1.10-2.x86_64 dapl-debuginfo-2.1.10-2.x86_64 dapl-devel-2.1.10-2.x86_64 dapl-devel-static-2.1.10-2.x86_64 dapl-utils-2.1.10-2.x86_64 fabtests-1.5.2-1.x86_64 fabtests-debuginfo-1.5.2-1.x86_64 ibacm-15-1.x86_64 ibutils-1.5.7-0.2.gbd7e502.x86_64 infiniband-diags-2.0.0-1.x86_64 infiniband-diags-devel-2.0.0-1.x86_64 iwpmd-15-1.x86_64 libfabric-1.5.2-1.x86_64 libfabric-debuginfo-1.5.2-1.x86_64 libfabric-devel-1.5.2-1.x86_64 libibcm-15-1.x86_64 libibumad-15-1.x86_64 libibverbs-15-1.x86_64 libibverbs-utils-15-1.x86_64 librdmacm-15-1.x86_64 librdmacm-utils-15-1.x86_64 mstflint-4.8.0-1.x86_64 ofed-docs-4.8-1.1.g005680d.x86_64 ofed-scripts-4.8-1.1.g1f6e1a2.x86_64 opensm-3.3.20-3.3.20.x86_64 opensm-debuginfo-3.3.20-3.3.20.x86_64 opensm-devel-3.3.20-3.3.20.x86_64 opensm-libs-3.3.20-3.3.20.x86_64 opensm-static-3.3.20-3.3.20.x86_64 perftest-3.4-0.9.g98a9a17.x86_64 qperf-0.4.9-1.x86_64 qperf-debuginfo-0.4.9-1.x86_64 rdma-core-15-1.x86_64 rdma-core-devel-15-1.x86_64 rds-tools-2.0.7-1.16.x86_64 srp_daemon-15-1.x86_64"

    touch /etc/yum/pluginconf.d/versionlock.list

    for item in ${version_list}; do
      echo ${item} >> /etc/yum/pluginconf.d/versionlock.list
    done

    echo -e "[main]\nenabled = 1\nlocklist = /etc/yum/pluginconf.d/versionlock.list" > /etc/yum/pluginconf.d/versionlock.conf

    # install our OFED repo:

    ofed_repo_file="https://www.fzu.cz/~jose/repo/OFED-4.8-1/3.10.0-514.26.2.el7.x86_64/OFED-4.8.1.repo"
    curl ${ofed_repo_file} > /etc/yum.repos.d/ofed.repo	#install OFED repo

    # update OS
    # - update of setup would break the things. IDN why.

    yum -y update -x setup

    # on top of latest OS + EPEL, install OHPC repo

    yum -y install https://github.com/openhpc/ohpc/releases/download/v1.3.GA/ohpc-release-1.3-1.el7.x86_64.rpm

    # .. and install all the well known tools and libs we like, including compute-node part of ohpc:

    yum -y install ohpc-base-compute lmod-ohpc EasyBuild-ohpc GitPython pysvn graphviz vim zlib-devel libyaml-devel gdbm-devel readline-devel ncurses-devel libffi-devel curl git redis libxml2-devel libxslt-devel libcurl-devel libicu-devel python libuuid-devel wget waf less openssl openssl-devel openssl-libs tree strace expect

    # slurm client can be useful for some tests..:

    yum -y install slurm-ohpc

    # distro build toolchain

    yum -y groupinstall "Development tools"

    # Install FPM as it is dependency of most manual/documentation builds

    yum -y install ruby-devel gcc make rpm-build rubygems	# ruby env and its deps
    gem install --no-ri --no-rdoc fpm				# fpm itself

    # man(ual)-related deps:

    yum -y install asciidoc xmlto man-db

    # ofed components
    # - it dependency of foss20XX-X

    yum -y install rdma-core-devel	#deps of foss2018b

    # deps of Mathematica

    yum -y install alsa-lib

    # latest EB:
    # - perhaps current OHPC is not using latest easybuild. So let's use build-in self-update feature of easybuild,
    #   and install (when needed) latest easybuild into /opt/eb. If we have latest EB, this will not do anything

    mkdir -p /sw/local/el7/x86_64
    mkdir -p /opt/eb && chmod -R 777 /opt/eb	# here we'll install the latest easybuild
    useradd eb	# local eb user as eb doesn't like root
    su eb -c "export EASYBUILD_BUILDPATH=/dev/shm && export EASYBUILD_MODULES_TOOL=Lmod && export EASYBUILD_PREFIX=/opt/eb && source /etc/profile.d/lmod.sh && module load EasyBuild && eb --install-latest-eb-release"

%environment
    export EASYBUILD_MODULES_TOOL=Lmod
    export EASYBUILD_PREFIX=/sw/local/el7/x86_64
    export EASYBUILD_BUILDPATH=/dev/shm

    source /etc/profile.d/lmod.sh
    module use /opt/eb/modules/all:/sw/local/el7/x86_64/modules/all:/opt/ohpc/pub/modulefiles:/etc/modulefiles
