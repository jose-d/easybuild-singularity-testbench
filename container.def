Bootstrap: shub
From: singularityhub/centos:latest

%runscript
    exec echo "#FIXME: The runscript is the containers default runtime command!"

%post
    #update centos, setup epel and install good packages
    yum -y install yum-utils epel-release yum-plugin-versionlock

    #OFED version lock and repo config ---

    #TODO: should be possible to replace with SMTH like "repoquery --disablerepo=* --enablerepo='OFED-4.8-1' -a"

    version_list="compat-rdma-4.8-1.1.gd5db855.3.10.0_514.26.2.el7.x86_64.x86_64 compat-rdma-devel-4.8-1.1.gd5db855.3.10.0_514.26.2.el7.x86_64.x86_64 dapl-2.1.10-2.x86_64 dapl-debuginfo-2.1.10-2.x86_64 dapl-devel-2.1.10-2.x86_64 dapl-devel-static-2.1.10-2.x86_64 dapl-utils-2.1.10-2.x86_64 fabtests-1.5.2-1.x86_64 fabtests-debuginfo-1.5.2-1.x86_64 ibacm-15-1.x86_64 ibutils-1.5.7-0.2.gbd7e502.x86_64 infiniband-diags-2.0.0-1.x86_64 infiniband-diags-devel-2.0.0-1.x86_64 iwpmd-15-1.x86_64 libfabric-1.5.2-1.x86_64 libfabric-debuginfo-1.5.2-1.x86_64 libfabric-devel-1.5.2-1.x86_64 libibcm-15-1.x86_64 libibumad-15-1.x86_64 libibverbs-15-1.x86_64 libibverbs-utils-15-1.x86_64 librdmacm-15-1.x86_64 librdmacm-utils-15-1.x86_64 mstflint-4.8.0-1.x86_64 ofed-docs-4.8-1.1.g005680d.x86_64 ofed-scripts-4.8-1.1.g1f6e1a2.x86_64 opensm-3.3.20-3.3.20.x86_64 opensm-debuginfo-3.3.20-3.3.20.x86_64 opensm-devel-3.3.20-3.3.20.x86_64 opensm-libs-3.3.20-3.3.20.x86_64 opensm-static-3.3.20-3.3.20.x86_64 perftest-3.4-0.9.g98a9a17.x86_64 qperf-0.4.9-1.x86_64 qperf-debuginfo-0.4.9-1.x86_64 rdma-core-15-1.x86_64 rdma-core-devel-15-1.x86_64 rds-tools-2.0.7-1.16.x86_64 srp_daemon-15-1.x86_64"

    touch /etc/yum/pluginconf.d/versionlock.list

    for item in ${version_list}; do
      echo ${item} >> /etc/yum/pluginconf.d/versionlock.list
    done

    echo -e "[main]\nenabled = 1\nlocklist = /etc/yum/pluginconf.d/versionlock.list" > /etc/yum/pluginconf.d/versionlock.conf

    yum install -y curl && curl fe2:/repo/ofed/ofed-4.8.1.repo > /etc/yum.repos.d/ofed.repo	#install OFED repo

    #end of OFED version lock.. ---

    yum -y update -x setup

    yum -y install https://github.com/openhpc/ohpc/releases/download/v1.3.GA/ohpc-release-1.3-1.el7.x86_64.rpm

    yum -y install ohpc-base-compute lmod-ohpc EasyBuild-ohpc GitPython pysvn graphviz vim zlib-devel libyaml-devel gdbm-devel readline-devel ncurses-devel libffi-devel curl git redis libxml2-devel libxslt-devel libcurl-devel libicu-devel python libuuid-devel
    yum -y groupinstall "Development tools"
    yum -y install openssl openssl-devel openssl-libs	#needed for some eb-builded sw

    #ofed components we need:
    yum -y install rdma-core-devel


    

    #mountpoints for EB sw tree:
    mkdir -p /sw/local/el7/x86_64
    mkdir -p /opt/eb
    chmod -R 777 /opt/eb

    useradd eb

    su eb -c "export EASYBUILD_BUILDPATH=/dev/shm && export EASYBUILD_MODULES_TOOL=Lmod && export EASYBUILD_PREFIX=/opt/eb && source /etc/profile.d/lmod.sh && module load EasyBuild && eb --install-latest-eb-release"

    
    

%environment
    export EASYBUILD_MODULES_TOOL=Lmod
    export EASYBUILD_PREFIX=/sw/local/el7/x86_64
    export EASYBUILD_BUILDPATH=/dev/shm
    source /etc/profile.d/lmod.sh
    module use /opt/eb/modules/all:/sw/local/el7/x86_64/modules/all:/opt/ohpc/pub/modulefiles:/etc/modulefiles
