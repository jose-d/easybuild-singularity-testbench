BootStrap: library
From: jose_d/default/debian9.6_hpc-base 

%help
    Base image for HPC using debian from docker repository

%post
    apt -y update

    # install Lua
    apt -y install libreadline-dev

    cd /usr/src
    wget http://www.lua.org/ftp/lua-5.3.5.tar.gz
    tar zxf lua-5.3.5.tar.gz
    cd lua-5.3.5
    make linux test
    make install

    # install luarocks
    apt -y install unzip
    cd /usr/local
    wget https://luarocks.org/releases/luarocks-3.1.3.tar.gz
    tar zxpf luarocks-3.1.3.tar.gz
    cd luarocks-3.1.3
    ./configure --prefix=/usr/local
    make build
    make install

    # install lmod and its dependencies
    apt -y install tcl-dev

    luarocks install luaposix
    luarocks install luafilesystem
    eval "$(luarocks path)"

    cd /usr/src
    wget https://github.com/TACC/Lmod/archive/8.1.13.tar.gz
    tar xvf 8.1.13.tar.gz
    cd Lmod-8.1.13 
    ./configure --prefix=/opt
    make install
    . /opt/lmod/lmod/init/profile


    # install Python 2.7:
    apt -y install build-essential checkinstall
    apt -y install libreadline-gplv2-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev

    cd /usr/src
    wget https://www.python.org/ftp/python/2.7.16/Python-2.7.16.tgz
    tar xzf Python-2.7.16.tgz

    cd Python-2.7.16
    ./configure --enable-optimizations
    make altinstall -j 33

    ln -s /usr/local/bin/python2.7 /usr/local/bin/python	#python = python2.7 :)

    # install pip
    curl -s -O https://bootstrap.pypa.io/get-pip.py
    python get-pip.py 
    pip2 install setuptools --upgrade


    # install Easybuild
    useradd eb
    EASYBUILD_MODULES_TOOL=lmod
    EASYBUILD_PREFIX=/opt/easybuild
    mkdir -p ${EASYBUILD_PREFIX}
    chown eb:eb ${EASYBUILD_PREFIX}


    su eb -c "cd $EASYBUILD_PREFIX && curl -O https://raw.githubusercontent.com/easybuilders/easybuild-framework/develop/easybuild/scripts/bootstrap_eb.py && python bootstrap_eb.py $EASYBUILD_PREFIX"

%environment

    export EASYBUILD_PREFIX=/opt/easybuild
    export EASYBUILD_MODULES_TOOL=lmod
    eval "$(luarocks path)"
    source /opt/lmod/lmod/init/profile
    # update $MODULEPATH, and load the EasyBuild module
    module use $EASYBUILD_PREFIX/modules/all
    module load EasyBuild
